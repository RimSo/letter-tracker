{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <h3 class="ms-2">üë• Manage Users</h3>
    </div>

    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
        ‚ûï Add User
    </button>
</div>

<!-- SEARCH USERS -->
<div class="mb-3">
  <input class="form-control" id="userSearch" placeholder="Search users‚Ä¶">
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="usersTable">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Email</th>
          <th>Badges</th>
          <th>Letters</th>
          <th>Last Login</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>

      {% for u in users %}
        <tr id="user-{{ u.id }}">
          <td>{{ u.id }}</td>

          <!-- USER with avatar -->
          <td>
            <div class="d-flex align-items-center">
              <img src="{{ url_for('static', filename='avatars/' ~ (u.avatar_path or 'default.png')) }}"
                   class="rounded-circle me-2"
                   style="width:40px; height:40px; object-fit:cover;">
              <strong>{{ u.name }}</strong>
            </div>
          </td>

          <!-- EMAIL with tooltip -->
          <td>
            <span data-bs-toggle="tooltip" title="Copied!" onclick="copyToClipboard('{{ u.email }}')"
                  style="cursor:pointer;">
              {{ u.email }}
            </span>
          </td>

          <!-- BADGES -->
          <td>
            {% if u.is_admin %}
              <span class="badge text-bg-warning">‚≠ê Admin</span>
            {% endif %}
            {% if u.verified %}
              <span class="badge text-bg-success">‚úî Verified</span>
            {% else %}
              <span class="badge text-bg-secondary">Unverified</span>
            {% endif %}
            {% if not u.active %}
              <span class="badge text-bg-danger">Inactive</span>
            {% endif %}
          </td>

          <!-- LETTER COUNT -->
          <td>
            <span class="badge text-bg-primary">{{ u.letter_count }}</span>
          </td>

          <!-- LAST LOGIN -->
          <td>
            {% if u.last_login %}
              <span class="text-muted">{{ u.last_login }}</span>
            {% else %}
              <span class="text-muted">Never</span>
            {% endif %}
          </td>

          <!-- ACTIONS -->
          <td class="text-end d-flex justify-content-end gap-2">

            <!-- EDIT (open modal) -->
            <button class="btn btn-sm btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#editUserModal{{ u.id }}">
              <i class="bi bi-pencil"></i>
            </button>

            <!-- RESET PASSWORD -->
            <a class="btn btn-warning btn-sm"
               href="{{ url_for('admin_reset_password', user_id=u.id) }}"
               onclick="return confirm('Send new temporary password?');">
              <i class="bi bi-key"></i>
            </a>

            <!-- DELETE -->
            <form method="POST"
                  action="{{ url_for('admin_delete_user', user_id=u.id) }}"
                  onsubmit="return confirm('Delete this user?');">
              <button class="btn btn-sm btn-danger">
                  <i class="bi bi-trash"></i>
              </button>
            </form>

          </td>
        </tr>

        {% include 'admin/_user_edit_modal.html' %}

      {% endfor %}

      </tbody>
    </table>
  </div>
</div>

{% include 'admin/_user_add_modal.html' %}

<script>
/* Search filter */
document.getElementById("userSearch").addEventListener("keyup", function () {
    let value = this.value.toLowerCase();
    document.querySelectorAll("#usersTable tbody tr").forEach(tr => {
        tr.style.display = tr.textContent.toLowerCase().includes(value) ? "" : "none";
    });
});

/* Copy email tooltip */
function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
}
</script>

{% endblock %}